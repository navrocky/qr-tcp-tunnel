## Протокол передачи

Этот документ описывает протокол обмена при помощи QR кодов и эмуляции ввода с клавиатуры.

## Общая часть

Данные передаются пакетами. Специфика транспортный формат пакета для разных интерфейсов описана в секциях ниже. 
Полезная нагрузка пакетов представляет собой команды с данными (RPC).

Транспортные коды команд:

`1` - Передаваемые данные. В теле команды передаются данные принятые из сокета. Порция данных может быть разбита 
на несколько пакетов.

`2` - Подтверждение приема пакетов. В теле команды передается номер последнего принятого пакета (1 байт). Принимающая 
сторона периодически отправляет подтверждение (например каждые 10 принятых пакетов, но не больше 255). 
Получив данную команду отправляющая сторона может выгрузить из памяти
подтвержденные пакеты, последующие запрос переотправки по ним должны приводить к ошибке.

`3` - Запрос переотправки пакетов начиная с указанного номера (1 байт). Получив данную команду отправляющая сторона 
должна начать переотправку пакетов.

## Передача данных при помощи QR кодов

Данные в QR кодируются в бинарном виде для большей плотности. QR генерируется с минимальной коррекцией ошибок.

Формат транспортного пакета:

1. Последовательный идентификатор пакета (1 байт) при переполнении счет начинается с нуля.
2. Код команды
3. Данные пакета

Общий размер пакета зависит от визуального размера QR кода.

Используя идентификатор пакета можно определить что мы считываем следующий пакет или потеряли несколько пакетов и надо 
повторить отправку.

## Передача данных при помощи эмуляции ввода с клавиатуры

Формат транспортного пакета:

1. "####" - стартовая последовательность
2. "00" - последовательный идентификатор пакета
3. "00" - HEX код команды
4. "0000" - HEX - размера данных пакета в base64
5. "00" - HEX - контрольной суммы размера
6. "00" - HEX - контрольной суммы base64 данных
7. base64 закодированные данные пакета

Стартовая последовательность позволяет определить начало передачи пакета из общего потока ввода в случае сбоя передачи.

Используя идентификатор пакета можно определить что мы считываем следующий пакет или потеряли несколько пакетов и надо 
повторить отправку.

В случае ошибки получения данных на любом этапе приема начинаем поиск стартовой последовательности.

